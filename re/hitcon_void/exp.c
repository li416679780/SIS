#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include <stdlib.h>

void aes_decrypt(uint8_t *ctext, uint8_t *flag, uint8_t *round_keys) {
	asm volatile (	"movdqu (%0), %%xmm11	\n" 
   	    		"movdqu (%1), %%xmm10	\n" 
	    		"movdqu (%2), %%xmm9	\n"
			"movdqu (%3), %%xmm8	\n" 
			"movdqu (%4), %%xmm7	\n" 
			"movdqu	(%5), %%xmm6	\n" 
			"movdqu (%6), %%xmm5	\n" 
			"movdqu (%7), %%xmm4	\n" 
			"movdqu (%8), %%xmm3	\n" 
			"movdqu (%9), %%xmm2	\n" 
			"movdqu (%10), %%xmm1	\n" 
			"movdqu (%11), %%xmm0	\n" 
			
			"aesimc %%xmm9, %%xmm9	\n"
	     		"aesimc %%xmm8, %%xmm8	\n"
	     		"aesimc %%xmm7, %%xmm7	\n"
	     		"aesimc %%xmm6, %%xmm6	\n"
	     		"aesimc %%xmm5, %%xmm5	\n"
	     		"aesimc %%xmm4, %%xmm4	\n"
	     		"aesimc %%xmm3, %%xmm3	\n"
	     		"aesimc %%xmm2, %%xmm2	\n"
	     		"aesimc %%xmm1, %%xmm1	\n"
			
			"pxor 	%%xmm10, %%xmm11\n"
	     		"aesdec %%xmm9, %%xmm11	\n"
	     		"aesdec %%xmm8, %%xmm11	\n"
	     		"aesdec %%xmm7, %%xmm11	\n"
	     		"aesdec %%xmm6, %%xmm11	\n"
	     		"aesdec %%xmm5,	%%xmm11	\n"
	     		"aesdec %%xmm4, %%xmm11	\n"
	    	 	"aesdec %%xmm3, %%xmm11	\n"
	     		"aesdec %%xmm2, %%xmm11	\n"
	     		"aesdec %%xmm1, %%xmm11	\n"
	     		"aesdeclast %%xmm0, %%xmm11\n"
			
			"movdqu %%xmm11, (%12)	\n"
			
			:
			:  "r"(ctext),
			   "r"(round_keys + 160),
		       	   "r"(round_keys + 144),
			   "r"(round_keys + 128),
			   "r"(round_keys + 112),
			   "r"(round_keys + 96),
			   "r"(round_keys + 80),
			   "r"(round_keys + 64),
			   "r"(round_keys + 48),
			   "r"(round_keys + 32),
			   "r"(round_keys + 16),
			   "r"(round_keys),
			   "r"(flag)
			: "memory"
	);
}

int main() {
  uint8_t flag[17];
  uint8_t round_keys[] = { 0x48, 0xc1, 0xfd, 0x03, 0xe8, 0x07, 0xfe, 0xff, 
			  0xff, 0x48, 0x85, 0xed, 0x74, 0x20, 0x31, 0xdb, 
			  0x0f, 0x1f, 0x84, 0x00, 0x00, 0x00, 0x00, 0x00, 
			  0x4c, 0x89, 0xea, 0x4c, 0x89, 0xf6, 0x44, 0x89, 
			  0xff, 0x41, 0xff, 0x14, 0xdc, 0x48, 0x83, 0xc3, 
			  0x01, 0x48, 0x39, 0xdd, 0x75, 0xea, 0x48, 0x83, 
			  0xc4, 0x08, 0x5b, 0x5d, 0x41, 0x5c, 0x41, 0x5d, 
			  0x41, 0x5e, 0x41, 0x5f, 0xc3, 0x90, 0x66, 0x2e, 
			  0x0f, 0x1f, 0x84, 0x00, 0x00, 0x00, 0x00, 0x00, 
			  0xf3, 0xc3, 0x00, 0x00, 0x48, 0x83, 0xec, 0x08, 
			  0x48, 0x83, 0xc4, 0x08, 0xc3, 0x00, 0x00, 0x00, 
			  0x01, 0x00, 0x02, 0x00, 0x25, 0x73, 0x00, 0x68, 
			  0x69, 0x74, 0x63, 0x6f, 0x6e, 0x7b, 0x25, 0x73, 
			  0x7d, 0x0a, 0x00, 0x00, 0x01, 0x1b, 0x03, 0x3b, 
			  0x40, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 
			  0xbc, 0xfd, 0xff, 0xff, 0x8c, 0x00, 0x00, 0x00, 
			  0xcc, 0xfd, 0xff, 0xff, 0xb4, 0x00, 0x00, 0x00, 
			  0xec, 0xfd, 0xff, 0xff, 0x5c, 0x00, 0x00, 0x00, 
			  0x1c, 0xff, 0xff, 0xff, 0xcc, 0x00, 0x00, 0x00, 
			  0x57, 0xff, 0xff, 0xff, 0xec, 0x00, 0x00, 0x00, 
			  0x6c, 0xff, 0xff, 0xff, 0x0c, 0x01, 0x00, 0x00, 
			  0xdc, 0xff, 0xff, 0xff, 0x54, 0x01, 0x00, 0x00 };

  uint8_t ctext[] = {     0xe7, 0x47, 0x04, 0x12, 0x49, 0x6d, 0xcf, 0x47, 
	  		  0xb0, 0xe9, 0x1b, 0x17, 0x67, 0xfb, 0x46, 0x28};
  aes_decrypt(ctext, flag, round_keys);
  printf("hitcon{%s}\n", flag);
  return 0;
}